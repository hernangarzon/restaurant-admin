
<h1 class="title">ğŸ§¾ Pedidos</h1>

<!-- Cargando inicial -->
<div *ngIf="cargandoInicial" class="cargando">
  ğŸ”„ Cargando pedidos...
</div>

<!-- Actualizando -->
<div *ngIf="!cargandoInicial && actualizando" class="actualizando">
  ğŸ”„ Actualizando...
</div>

<!-- âœ… FILTROS SIEMPRE VISIBLES -->
<!-- âœ… FILTROS SIEMPRE VISIBLES -->
<div class="filtros-container">
  <!-- BÃºsqueda por telÃ©fono -->
  <div class="search-wrapper">
    <input 
      type="text" 
      placeholder="ğŸ” Buscar por telÃ©fono..." 
      #inputTelefono
      (input)="buscarPorTelefono(inputTelefono.value)"
      class="search-input"
      [value]="filtroTelefono"
    />
    <button 
      class="clear-search" 
      (click)="limpiarBusquedaTelefono()" 
      *ngIf="filtroTelefono"
      title="Limpiar bÃºsqueda"
    >
      Ã—
    </button>
  </div>
  
  <select #selectEstado (change)="filtrarEstado(selectEstado.value)">
    <option value="">Todos los estados</option>
    <option value="NUEVO">Nuevo</option>
    <option value="EN_PREPARACION">En preparaciÃ³n</option>
    <option value="LISTO">Listo</option>
    <option value="ENTREGADO">Entregado</option>
  </select>

  <select #selectFecha (change)="filtrarFecha(selectFecha.value)">
    <option value="TODOS">Todos los dÃ­as</option>
    <option value="HOY">Solo hoy</option>
    <option value="AYER">Ayer</option>
    <option value="ULTIMA_SEMANA">Ãšltima semana</option>
  </select>
</div>

<!-- (OPCIONAL) Contador de resultados -->
<div class="resultados-info" *ngIf="!cargandoInicial && pedidos.length > 0">
  <span class="badge info">
    ğŸ“Š {{ pedidos.length }} pedido{{ pedidos.length !== 1 ? 's' : '' }} encontrado{{ pedidos.length !== 1 ? 's' : '' }}
    <span *ngIf="filtroTelefono"> â€¢ TelÃ©fono: {{ filtroTelefono }}</span>
    <span *ngIf="estadoFiltro"> â€¢ Estado: {{ estadoFiltro.replace('_', ' ') }}</span>
    <span *ngIf="fechaFiltro !== 'TODOS'"> â€¢ {{ obtenerTextoFiltroFecha() }}</span>
  </span>
</div>

<!-- âœ… TABLA SOLO SI HAY DATOS -->
<div *ngIf="!cargandoInicial && pedidos.length > 0">
  <!-- ... tu tabla actual ... -->
</div>

<!-- Mensaje vacÃ­o -->
<div *ngIf="!cargandoInicial && pedidos.length === 0" class="no-results">
  <p *ngIf="filtroTelefono || estadoFiltro || fechaFiltro !== 'TODOS'">
    ğŸ§ No se encontraron pedidos con los filtros aplicados
    <button class="btn-link" (click)="limpiarTodosFiltros()">Limpiar filtros</button>
  </p>
  <p *ngIf="!filtroTelefono && !estadoFiltro && fechaFiltro === 'TODOS'">
    No hay pedidos ğŸ½ï¸
  </p>
</div>

<!-- âœ… TABLA SOLO SI HAY DATOS -->
<div *ngIf="!cargandoInicial && pedidos.length > 0">

  <table class="table">
    <thead>
      <tr>
        <th>Fecha</th>
        <th>TelÃ©fono</th>
        <th>Nombre</th>
        <th>ğŸ“ DescripciÃ³n</th>
        <th>Estado</th>
        <th>Detalle</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let p of pedidos">
        <td>{{ p.fecha | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>{{ p.telefonoCliente || 'Sin telÃ©fono' }}</td>
        <td>{{ p.nombreCliente || 'â€”' }}</td>
        <td>{{ p.descripcion }}</td>

        <td>
          <span
            *ngIf="p.estado !== 'ENTREGADO'; else finalizado"
            class="badge estado-animado"
            [ngClass]="p.estado.toLowerCase()"
          >
            {{ p.estado.replace('_', ' ') }}
          </span>

          <ng-template #finalizado>
            <span class="badge entregado estado-finalizado">
              âœ” Pedido Entregado
            </span>
          </ng-template>
        </td>

        <td>
          <button 
            class="btn detail-btn"
            (click)="verDetalle(p)"
            title="Ver detalles del pedido"
          >
            ğŸ“‹ Ver detalle
          </button>
        </td>

        <td class="actions">
          <button
              class="btn primary"
              (click)="cambiarEstado(p)"
              [disabled]="!puedeCambiarEstado(p.estado)"
          >
              Cambiar estado
          </button>
          <button
              class="btn danger"
              (click)="cancelarPedido(p)"
              *ngIf="p.estado !== 'ENTREGADO' && p.estado !== 'CANCELADO'"
          >
              âŒ Cancelar
          </button>
      </td>
      </tr>
    </tbody>
  </table>

</div>

<!-- Mensaje vacÃ­o -->
<div *ngIf="!cargandoInicial && pedidos.length === 0">
  <p>No hay pedidos con ese estado ğŸ½ï¸</p>
</div>

<!-- MODAL PARA DETALLES -->
<!-- MODAL PARA DETALLES -->
<div *ngIf="mostrarModal && pedidoSeleccionado" class="modal-overlay" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <!-- ENVOLVER TODO en *ngIf para asegurar que pedidoSeleccionado no sea undefined -->
    <div *ngIf="pedidoSeleccionado">
      
      <div class="modal-header">
        <h2>ğŸ“„ Detalle del Pedido #{{ pedidoSeleccionado.id }}</h2>
        <button class="close-btn" (click)="cerrarModal()">Ã—</button>
      </div>
      
      <div class="modal-body">
        
        <div class="detail-section">
          <h3>ğŸ‘¤ InformaciÃ³n del Cliente</h3>
          <p><strong>Nombre:</strong> {{ pedidoSeleccionado.nombreCliente || 'No disponible' }}</p>
          <p><strong>TelÃ©fono:</strong> {{ pedidoSeleccionado.telefonoCliente || 'No disponible' }}</p>
        </div>
        
        <div class="detail-section">
          <h3>ğŸ½ï¸ DescripciÃ³n del Pedido</h3>
          <div class="description-box">
            {{ pedidoSeleccionado.descripcion || 'Sin descripciÃ³n' }}
          </div>
        </div>
        
        <div class="detail-section">
          <h3>ğŸ“ DirecciÃ³n de Entrega</h3>
          <div *ngIf="pedidoSeleccionado.direccion; else sinDireccion" class="address-box">
            ğŸ“ {{ pedidoSeleccionado.direccion }}
          </div>
          <ng-template #sinDireccion>
            <div class="no-address">
              <span class="warning-icon">âš ï¸</span>
              <p>No se registrÃ³ direcciÃ³n de entrega</p>
              <small>El cliente debe proporcionar direcciÃ³n al confirmar el pedido</small>
            </div>
          </ng-template>
        </div>
        
        <div class="detail-section">
          <h3>ğŸ“Š InformaciÃ³n del Pedido</h3>
          <div class="info-grid">
            <div class="info-item">
              <strong>Fecha:</strong>
              <span>{{ pedidoSeleccionado.fecha | date:'dd/MM/yyyy HH:mm:ss' }}</span>
            </div>
            <div class="info-item">
              <strong>Estado:</strong>
              <span class="badge" [ngClass]="pedidoSeleccionado.estado.toLowerCase()">
                {{ pedidoSeleccionado.estado.replace('_', ' ') }}
              </span>
            </div>
            <div class="info-item" *ngIf="pedidoSeleccionado.restaurante">
              <strong>Restaurante:</strong>
              <span>{{ pedidoSeleccionado.restaurante.nombre }}</span>
            </div>
            <div class="info-item">
              <strong>ID Pedido:</strong>
              <span>#{{ pedidoSeleccionado.id }}</span>
            </div>
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer">
        <button class="btn secondary" (click)="cerrarModal()">Cerrar</button>
        <button 
          class="btn primary" 
          *ngIf="puedeCambiarEstado(pedidoSeleccionado.estado)"
          (click)="cambiarEstadoDesdeModal()"
        >
          Avanzar estado
        </button>
      </div>
      
    </div> <!-- Fin del *ngIf="pedidoSeleccionado" -->
    
  </div>
</div>